/*
 * -------------------------------------------------
 *  Nextflow config file for v6 chr21 phased imputation
 *  Updated for Pipeline v2.0
 * -------------------------------------------------
 * Uses v6.cgp.vf.va.filter-pass.chr21_chr21_5030081_15030080_phased.vcf.gz
 * as target data with H3Africa reference panels
 */

// Set work directory
workDir = '/scratch3/users/mamana/nextflow-work'

params {
  // Project metadata
  project_name            = 'v6_chr21_phased_imputation'
  project_description     = 'Imputation test using v6 chr21 phased data'
  
  // =====================================================
  // v2.0 PARAMETER NAMES (following nf-core standards)
  // =====================================================
  
  // Input/Output options
  input                   = "${projectDir}/samplesheet_chr21.csv"
  outdir                  = "output/v6_chr21_phased_imputation"
  publish_dir_mode        = 'copy'
  
  // Reference genome options  
  genome                  = null
  genome_build            = 'b38'  // or 'hg38'
  reference_genome        = "/cbio/dbs/gatk/hg38/Homo_sapiens_assembly38.fasta"
  eagle_genetic_map       = "/cbio/dbs/refpanels/eagle/tables/genetic_map_hg19_withX.txt.gz"
  
  // Reference panels - using H3Africa v7 panels for chr21
  // Format: [name, m3vcf_path, vcf_path]
  reference_panels = [
    ['V7HC-S', '/cbio/dbs/refpanels/h3a_reference_panels/version_7/v7hc_s/msavs/V7HC-S_chr21_all.v2025.05.msav', '/cbio/dbs/refpanels/h3a_reference_panels/version_7/v7hc_s/bcfs/V7HC-S_chr21_all.bcf']
  ]
  
  // Chromosomes to process
  chromosomes             = "21"  // Specific to chr21 since that's what the file contains
  
  // QC options (v2.0 naming)
  qc_min_ac               = 2       // Minimum allele count (was 'min_ac')
  qc_min_maf              = 0.01    // Minimum allele frequency (was 'maf_thresh')
  qc_max_missing          = 0.05    // Maximum missingness (was 'site_miss')
  qc_hwe_pvalue           = 1e-5    // HWE p-value threshold (was 'hwe')
  remove_duplicates       = true
  split_multiallelic      = true
  
  // Chunking options
  enable_chunking         = true      // Enable VCF chunking for parallel processing
  chunk_size              = 5000000   // 5Mb chunks for genomic region-based chunking
  overlap_min_ratio       = 0.00001   // Minimum overlap ratio (0.001%) for chunk merging
  
  // Phasing options (v2.0 naming)
  phasing_tool            = 'eagle'  // Options: 'eagle', 'shapeit', 'beagle' (was 'phasing_method')
  
  // Imputation options (v2.0 naming)  
  imputation_tool         = 'minimac4'  // Options: 'minimac4', 'impute5', 'beagle5' (was 'impute_method')
  impute_info_cutoff      = 0.3
  impute_window           = 500000
  impute_min_ratio        = 0.01      // Minimac4 minRatio (was 'minRatio')
  impute_ne               = 20000     // Effective population size (was 'NE')
  impute_buffer           = 500000    // Buffer size (was 'buffer_size')
  
  // Reporting options
  report_level            = 'detailed'  // Options: 'summary', 'detailed', 'full'
  generate_plots          = true
  concordance_analysis    = false
  
  // Validation options (speed optimizations)
  skip_vcf_stats          = true   // Skip detailed VCF statistics
  skip_chr_validation     = true   // Skip chromosome validation (we know it's chr21)
  skip_ref_compatibility  = true   // Skip reference compatibility check
  skip_sample_overlap     = true   // Skip sample overlap check
  
  // Computational resources
  max_cpus                = 4
  max_memory              = '8.GB'
  max_time                = '12.h'
  
  // Boilerplate options
  help                    = false
  version                 = false
  validate_params         = true
  show_hidden_params      = false
  schema_ignore_params    = 'genomes,modules'
  monochrome_logs         = false
  
  // Email notifications
  email                   = null
  email_on_fail           = null
  plaintext_email         = false
}

// Nextflow execution reports
timeline {
  enabled = true
  file = "${params.outdir}/pipeline_info/${params.project_name}_timeline.html"
  overwrite = true
}

report {
  enabled = true
  file = "${params.outdir}/pipeline_info/${params.project_name}_report.html"
  overwrite = true
}

trace {
  enabled = true
  file = "${params.outdir}/pipeline_info/${params.project_name}_trace.txt"
  overwrite = true
}

dag {
  enabled = true
  file = "${params.outdir}/pipeline_info/${params.project_name}_dag.html"
  overwrite = true
}

// Process-specific resource requirements (following v2.0 labels)
process {
  withLabel: 'process_single' {
    cpus = 1
    memory = '2.GB'
    time = '2.h'
  }
  
  withLabel: 'process_low' {
    cpus = 2
    memory = '4.GB'
    time = '4.h'
  }
  
  withLabel: 'process_medium' {
    cpus = 2
    memory = '4.GB'
    time = '8.h'
  }
  
  withLabel: 'process_high' {
    cpus = 3
    memory = '6.GB'
    time = '16.h'
  }
  
  withLabel: 'process_long' {
    time = '24.h'
  }
  
  withLabel: 'process_high_memory' {
    memory = '8.GB'
  }
}

// Profile configurations
profiles {
  singularity {
    singularity.enabled = true
    singularity.autoMounts = true
    singularity.runOptions = "-B \$HOME -B /cbio"
  }
  
  slurm {
    process.executor = 'slurm'
    process.queue = 'Main'
    executor.queueSize = 5
  }
  
  test {
    executor.queueSize = 5
    params.max_cpus = 2
    params.max_memory = '4.GB'
    params.max_time = '2.h'
  }
}

/*
 * PARAMETER MAPPING FROM OLD TO NEW
 * ===================================
 * Old Parameter          -> New Parameter
 * -----------------------------------
 * outDir                 -> outdir
 * ref_panels             -> reference_panels
 * target_datasets        -> input (now uses samplesheet)
 * site_miss              -> qc_max_missing
 * hwe                    -> qc_hwe_pvalue
 * mac                    -> qc_min_ac
 * min_ac                 -> qc_min_ac
 * maf_thresh             -> qc_min_maf
 * phasing_method         -> phasing_tool
 * impute_method          -> imputation_tool
 * NE                     -> impute_ne
 * buffer_size            -> impute_buffer
 * minRatio               -> impute_min_ratio
 * impute_info_cutoff     -> impute_info_cutoff (unchanged)
 * chunk_size             -> chunk_size (unchanged)
 */