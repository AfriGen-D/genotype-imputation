name: Build and Push Modular Docker Images

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  # Optional: Build weekly to keep images updated
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

env:
  REGISTRY: ghcr.io

jobs:
  build-modular:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    strategy:
      matrix:
        container:
          - name: vcf-processing
            context: ./containers/vcf-processing
            description: "VCF processing tools (BCFtools, VCFtools, tabix) for genotype imputation QC"
          - name: phasing
            context: ./containers/phasing  
            description: "Haplotype phasing tools (Eagle, tabix) for genotype imputation"
          - name: imputation
            context: ./containers/imputation
            description: "Genotype imputation tools (Minimac4, BCFtools, VCFtools)"
          - name: analysis
            context: ./containers/analysis
            description: "Analysis and reporting tools (BCFtools, Python, R) for imputation results"
          - name: genotype-imputation
            context: ./containers/all-in-one
            description: "Complete genotype imputation environment with all tools"
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.container.name }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value={{date 'YYYY-MM-DD'}},enable={{is_default_branch}}
        labels: |
          org.opencontainers.image.title=${{ matrix.container.name }}
          org.opencontainers.image.description=${{ matrix.container.description }}
          org.opencontainers.image.vendor=AfriGen-D Consortium
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.container.context }}
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ matrix.container.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.container.name }}
        
    - name: Generate artifact attestation
      if: github.event_name != 'pull_request'
      uses: actions/attest-build-provenance@v1
      with:
        subject-name: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.container.name }}
        subject-digest: ${{ steps.build.outputs.digest }}
        push-to-registry: true

  # Summary job to check if all builds succeeded
  build-summary:
    runs-on: ubuntu-latest
    needs: build-modular
    if: always()
    steps:
    - name: Check build results
      run: |
        echo "Build Summary:"
        echo "=============="
        if [ "${{ needs.build-modular.result }}" == "success" ]; then
          echo "✅ All modular containers built successfully!"
          echo ""
          echo "Available containers:"
          echo "- ghcr.io/${{ github.repository_owner }}/vcf-processing:latest"
          echo "- ghcr.io/${{ github.repository_owner }}/phasing:latest"
          echo "- ghcr.io/${{ github.repository_owner }}/imputation:latest"
          echo "- ghcr.io/${{ github.repository_owner }}/analysis:latest"
          echo "- ghcr.io/${{ github.repository_owner }}/genotype-imputation:latest"
        else
          echo "❌ Some container builds failed"
          exit 1 